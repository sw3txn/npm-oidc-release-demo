name: Create Release PR
description: Check for release, then create or update release branch and PR

inputs:
  github-token:
    description: 'GitHub token for API access'
    required: true

runs:
  using: composite
  steps:
    - name: Check and validate release commit
      id: check
      shell: bash
      run: |
        if git diff --quiet HEAD origin/main; then
          echo "No release commit detected"
          exit 0
        fi

        VERSION=$(node -p "require('./package.json').version")
        COMMIT_TITLE=$(git log -1 --pretty=%s)
        EXPECTED_TITLE="chore(release): $VERSION"

        if [ "$COMMIT_TITLE" != "$EXPECTED_TITLE" ]; then
          echo "âŒ Invalid release commit"
          echo "   Expected: $EXPECTED_TITLE"
          echo "   Got:      $COMMIT_TITLE"
          exit 1
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected release commit for v$VERSION"

    - name: Push release branch
      if: steps.check.outputs.version != ''
      shell: bash
      env:
        BRANCH: release/v${{ steps.check.outputs.version }}
      run: |
        git checkout -B "$BRANCH"
        git push --force-with-lease origin "$BRANCH"

    - name: Create or update release PR
      if: steps.check.outputs.version != ''
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        BRANCH: release/v${{ steps.check.outputs.version }}
        VERSION: ${{ steps.check.outputs.version }}
      run: |
        PR_NUMBER=$(gh pr list --base main --head "$BRANCH" --json number --jq '.[0].number')

        if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
          COMMIT_TITLE=$(git log -1 --pretty=%s)
          COMMIT_BODY=$(git log -1 --pretty=%b)
          gh pr edit "$PR_NUMBER" --title "$COMMIT_TITLE" --body "$COMMIT_BODY"
          echo "Updated PR #$PR_NUMBER"
        else
          gh pr create --base main --head "$BRANCH"
          echo "Created PR for v$VERSION"
        fi
